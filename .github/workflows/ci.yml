name: CI Pipeline
run-name: CI by ${{ github.actor }}

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  CI: true
  CONTAINER_TARGET: ci

jobs:
  # ============================================
  # Quick checks (format, version) - fail fast
  # ============================================
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build CI-Container
        run: ./scripts/container.sh echo "container ready"

      - name: Format Check
        run: ./scripts/container.sh ./scripts/ci-cd/step_format.sh

      - name: Version Check
        if: github.event_name == 'pull_request'
        run: ./scripts/container.sh ./scripts/ci-cd/step_version.sh

  # ============================================
  # Build and Test
  # ============================================
  build-and-test:
    runs-on: ubuntu-latest
    needs: checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build CI-Container
        run: ./scripts/container.sh echo "container ready"

      - name: Build
        run: ./scripts/container.sh ./scripts/ci-cd/step_build.sh

      - name: Test
        run: ./scripts/container.sh ./scripts/ci-cd/step_test.sh

      - name: Memory Check
        run: ./scripts/container.sh ./scripts/ci-cd/step_memcheck.sh

  # ============================================
  # Packaging
  # ============================================
  package:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build CI-Container
        run: ./scripts/container.sh echo "container ready"

      - name: Package
        run: ./scripts/container.sh ./scripts/ci-cd/step_package.sh
