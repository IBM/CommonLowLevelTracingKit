name: CI Pipeline
run-name: CI by ${{ github.actor }}

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  CI: true
  CONTAINER_TARGET: ci

jobs:
  # ============================================
  # Build container once and share via artifact
  # ============================================
  build-container:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Calculate container tag
        id: tag
        run: |
          MD5_SUM=$(md5sum ./scripts/container.Dockerfile | cut -d' ' -f1)
          echo "md5=$MD5_SUM" >> $GITHUB_OUTPUT
          echo "tag=clltk_ci-ci-$MD5_SUM" >> $GITHUB_OUTPUT

      - name: Restore cached container
        id: cache
        uses: actions/cache@v4
        with:
          path: /tmp/ci-container.tar
          key: ci-container-${{ steps.tag.outputs.md5 }}

      - name: Build CI-Container
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          docker build --file ./scripts/container.Dockerfile --target ci --tag ${{ steps.tag.outputs.tag }} .
          docker save ${{ steps.tag.outputs.tag }} -o /tmp/ci-container.tar

      - name: Upload container
        uses: actions/upload-artifact@v4
        with:
          name: ci-container
          path: /tmp/ci-container.tar
          retention-days: 90

  # ============================================
  # Quick checks (format, version) - fail fast
  # ============================================
  checks:
    runs-on: ubuntu-latest
    needs: build-container
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load CI-Container
        uses: ./.github/actions/load-container

      - name: Format Check
        run: ./scripts/container.sh ./scripts/ci-cd/step_format.sh

      - name: Version Check
        if: github.event_name == 'pull_request'
        run: ./scripts/container.sh ./scripts/ci-cd/step_version.sh

  # ============================================
  # Build and Test
  # ============================================
  build-and-test:
    runs-on: ubuntu-latest
    needs: [build-container, checks]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load CI-Container
        uses: ./.github/actions/load-container

      - name: Build
        run: ./scripts/container.sh ./scripts/ci-cd/step_build.sh

      - name: Test
        run: ./scripts/container.sh ./scripts/ci-cd/step_test.sh

      - name: Memory Check
        run: ./scripts/container.sh ./scripts/ci-cd/step_memcheck.sh

  # ============================================
  # Packaging
  # ============================================
  package:
    runs-on: ubuntu-latest
    needs: [build-container, build-and-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load CI-Container
        uses: ./.github/actions/load-container

      - name: Package
        run: ./scripts/container.sh ./scripts/ci-cd/step_package.sh
